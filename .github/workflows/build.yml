name: Build and Release ZMK Firmware
on:
  push:
    branches:
      - main
    tags:
      - "v1.0.1"
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      groups: ${{ steps.make-groups.outputs.groups }}

    steps:
      - name: Checkout repo (no submodules)
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: OS deps
        run: sudo apt-get update && sudo apt-get install -y jq

      # Uncomment if you want to generate additional keymaps
      # - name: Generate extra keymaps
      #   run: |
      #     echo "‚öôÔ∏è Generating additional keymaps"
      #     mv config/keymap/charybdis.keymap config/keymap/qwerty.keymap

      - uses: actions/upload-artifact@v4
        with:
          name: generated-keymaps
          path: config/keymap/

      - name: Build-matrix JSON
        run: python scripts/generate_matrix.py > build.json

      - id: make-groups
        run: |
          echo "groups=$(jq -c 'map(select(.format=="bt" or .format=="reset")|{keymap,format,name,board})' build.json)" >>"$GITHUB_OUTPUT"
          echo "‚öôÔ∏è Build Matrix Created"
          cat build.json | jq .

  build:
    name: Build (${{ matrix.combo.name }})
    needs: setup
    runs-on: ubuntu-latest
    container: zmkfirmware/zmk-build-arm:stable

    strategy:
      fail-fast: false
      matrix:
        combo: ${{ fromJson(needs.setup.outputs.groups) }}

    steps:
      - name: Install tree
        run: apt-get update && apt-get install -y tree

      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Initialise West workspace
        shell: bash
        run: |
          set -euxo pipefail
          echo "‚ú® Initializing the west workspace with the local manifest from config/west.yml."
          west init -l --mf $GITHUB_WORKSPACE/config/west.yml "$GITHUB_WORKSPACE/config"
          echo "üîÑ Updating and synchronizing all repositories in the workspace."
          west update
          echo "üì¶ Exporting Zephyr for external build system integration."
          west zephyr-export

          echo "ü™≥ Debug Logs"
          echo "üëÄ Top dir  : $(west topdir)"
          echo "üëÄ Projects :"
          ls -1 $(west topdir)
          echo "üëÄ West workspace ready. Project structure:"
          west list

      - name: Download keymaps
        uses: actions/download-artifact@v4
        with:
          name: generated-keymaps
          path: config/keymap

      - name: Stage keymaps and overlays into source tree
        shell: bash
        run: |
          mkdir -p zmk/app/overlays

          # Copy only keymap file, exclude copying *.dtsi files to overlays to avoid duplication issues
          if [[ "${{ matrix.combo.format }}" != "reset" ]]; then
            cp config/keymap/${{ matrix.combo.keymap }}.keymap zmk/app/overlays/charybdis.keymap
          fi

      - name: Inject custom shields
        if: ${{ matrix.combo.format != 'reset' }}
        shell: bash
        run: |
          ZMK_SHIELDS_DIR="$GITHUB_WORKSPACE/zmk/app/boards/shields"
          mkdir -p "$ZMK_SHIELDS_DIR"
          # Copy only the shield folder corresponding to format (bt), no extra dtsi copied here
          cp -r "boards/shields/charybdis_${{ matrix.combo.format }}" "$ZMK_SHIELDS_DIR/"

      - name: Build combo ${{ matrix.combo.name }}
        shell: bash
        working-directory: zmk/app
        run: |
          set -euo pipefail

          KM="${{ matrix.combo.keymap }}"
          FM="${{ matrix.combo.format }}"
          NM="${{ matrix.combo.name }}"
          BD="${{ matrix.combo.board }}"

          declare -A LIST=(
            [bt]="charybdis_left charybdis_right"
            [reset]="settings_reset"
          )

          mkdir -p "$GITHUB_WORKSPACE/out/$NM"
          CONFIG_DIR="$GITHUB_WORKSPACE/config"

          for SH in ${LIST[$FM]}; do
            BUILD_DIR=$(mktemp -d)

            if [[ "$FM" == "bt" && "$SH" == *right ]]; then
              SNIPPET_OPTION="-DSNIPPET=studio-rpc-usb-uart"
            else
              SNIPPET_OPTION=""
            fi

            if [[ "$FM" != "reset" ]]; then
              KEYMAP_OPTION="-DKEYMAP_FILE=overlays/charybdis.keymap"
            else
              KEYMAP_OPTION=""
            fi

            echo "ü™≥ Debug Logs"
            echo "Build Variables:"
            echo "‚Üí Keymap    : $KM"
            echo "‚Üí Format    : $FM"
            echo "‚Üí Name      : $NM"
            echo "‚Üí Board     : $BD"
            echo "‚Üí KeymapOpt : $KEYMAP_OPTION"
            echo "‚Üí Snippet   : $SNIPPET_OPTION"
            echo "‚Üí Build dir : $BUILD_DIR"

            echo "üõ† Starting build..."
            west build -p \
              -d "$BUILD_DIR" \
              -b "$BD" \
              -- \
              "-DZMK_CONFIG=$CONFIG_DIR" \
              "-DSHIELD=$SH" \
              "$KEYMAP_OPTION" \
              "$SNIPPET_OPTION"

            ART=$(if [[ -f "$BUILD_DIR/zephyr/zmk.uf2" ]]; then echo zmk.uf2; else echo zmk.bin; fi)
            cp "$BUILD_DIR/zephyr/$ART" "$GITHUB_WORKSPACE/out/$NM/$SH.${ART##*.}"
          done

      - name: Upload firmware bundle
        uses: actions/upload-artifact@v4
        with:
          name: charybdis-${{ matrix.combo.name }}
          path: ${{ github.workspace }}/out/${{ matrix.combo.name }}/**

  release-firmware:
    name: Release Firmware
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with: { path: combo-artifacts/ }

      - name: Zip each combo
        working-directory: combo-artifacts
        run: |
          for d in */; do
            zip -j "${d%/}.zip" "$d"*
          done

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Firmware Release ${{ github.ref_name }}
          files: combo-artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
