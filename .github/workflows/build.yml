name: Build and Release ZMK Firmware
on:
  push:
    branches:
      - main
    tags:
      - "v1.0.1"
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      groups: ${{ steps.make-groups.outputs.groups }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - run: sudo apt-get update && sudo apt-get install -y jq

      - uses: actions/upload-artifact@v4
        with:
          name: generated-keymaps
          path: config/keymap/

      - run: python scripts/generate_matrix.py > build.json

      - id: make-groups
        run: |
          echo "groups=$(jq -c 'map(select(.format=="bt" or .format=="reset") \
            | {keymap,format,name,board})' build.json)" >>"$GITHUB_OUTPUT"
          cat build.json | jq .

  build:
    needs: setup
    runs-on: ubuntu-latest
    container: zmkfirmware/zmk-build-arm:stable

    strategy:
      fail-fast: false
      matrix:
        combo: ${{ fromJson(needs.setup.outputs.groups) }}

    steps:
      - run: apt-get update && apt-get install -y tree

      - uses: actions/checkout@v4

      - run: |
          set -euxo pipefail
          west init -l --mf $GITHUB_WORKSPACE/config/west.yml "$GITHUB_WORKSPACE/config"
          west update
          west zephyr-export

      - uses: actions/download-artifact@v4
        with:
          name: generated-keymaps
          path: config/keymap

      - run: |
          mkdir -p zmk/app/overlays
          if [[ "${{ matrix.combo.format }}" != "reset" ]]; then
            cp config/keymap/${{ matrix.combo.keymap }}.keymap zmk/app/overlays/charybdis.keymap
            cp config/keymap/behaviors.dtsi zmk/app/overlays/ 2>/dev/null || true
            cp config/keymap/combos.dtsi zmk/app/overlays/ 2>/dev/null || true
            cp config/keymap/macros.dtsi zmk/app/overlays/ 2>/dev/null || true
          fi

      - run: |
          ZMK_SHIELDS_DIR="$GITHUB_WORKSPACE/zmk/app/boards/shields"
          mkdir -p "$ZMK_SHIELDS_DIR"
          cp -r "boards/shields/charybdis_${{ matrix.combo.format }}" "$ZMK_SHIELDS_DIR/"

      - shell: bash
        working-directory: zmk/app
        run: |
          set -euo pipefail
          KM="${{ matrix.combo.keymap }}"
          FM="${{ matrix.combo.format }}"
          NM="${{ matrix.combo.name }}"
          BD="${{ matrix.combo.board }}"
          declare -A LIST=(
            [bt]="charybdis_left charybdis_right"
            [reset]="settings_reset"
          )
          mkdir -p "$GITHUB_WORKSPACE/out/$NM"
          CONFIG_DIR="$GITHUB_WORKSPACE/config"
          for SH in ${LIST[$FM]}; do
            BUILD_DIR=$(mktemp -d)
            SNIPPET_OPTION=""
            [[ "$FM" == "bt" && "$SH" == *right ]] && SNIPPET_OPTION="-DSNIPPET=studio-rpc-usb-uart"
            KEYMAP_OPTION=""
            [[ "$FM" != "reset" ]] && KEYMAP_OPTION="-DKEYMAP_FILE=overlays/charybdis.keymap"

            echo "Building $SH for $FM format with keymap $KM"
            west build -p -d "$BUILD_DIR" -b "$BD" -- \
              "-DZMK_CONFIG=$CONFIG_DIR" \
              "-DSHIELD=$SH" \
              "$KEYMAP_OPTION" \
              "$SNIPPET_OPTION"
            ART=$(if [[ -f "$BUILD_DIR/zephyr/zmk.uf2" ]]; then echo zmk.uf2; else echo zmk.bin; fi)
            cp "$BUILD_DIR/zephyr/$ART" "$GITHUB_WORKSPACE/out/$NM/$SH.${ART##*.}"
          done

      - uses: actions/upload-artifact@v4
        with:
          name: charybdis-${{ matrix.combo.name }}
          path: ${{ github.workspace }}/out/${{ matrix.combo.name }}/**

  release-firmware:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: combo-artifacts/
      - run: |
          for d in */; do zip -j "${d%/}.zip" "$d"*; done
        working-directory: combo-artifacts
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Firmware Release ${{ github.ref_name }}
          files: combo-artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
