name: Build and Release ZMK Firmware
on:
  push:
    branches:
      - main
    tags:
      - "v1.0.1"
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      groups: ${{ steps.make-groups.outputs.groups }}

    steps:
      - name: Checkout repo (no submodules)
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: OS deps
        run: sudo apt-get update && sudo apt-get install -y jq

      - uses: actions/upload-artifact@v4
        with:
          name: generated-keymaps
          path: config/

      - name: Build-matrix JSON
        run: python scripts/generate_matrix.py > build.json

      - id: make-groups
        run: |
          # ÐžÑ‚Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð°Ð¼Ð¸ bt Ð¸ reset
          echo "groups=$(jq -c 'map(select(.format=="bt" or .format=="reset") | {keymap,format,name,board})' build.json)" >>"$GITHUB_OUTPUT"
          echo "âš™ï¸ Build Matrix Created"
          cat build.json | jq .

  build:
    name: Build (${{ matrix.combo.name }})
    needs: setup
    runs-on: ubuntu-latest
    container: zmkfirmware/zmk-build-arm:stable

    strategy:
      fail-fast: false
      matrix:
        combo: ${{ fromJson(needs.setup.outputs.groups) }}

    steps:
      - name: Install tree
        run: apt-get update && apt-get install -y tree

      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Initialise West workspace
        shell: bash
        run: |
          set -euxo pipefail
          echo "âœ¨ Init west workspace with local manifest."
          west init -l --mf $GITHUB_WORKSPACE/config/west.yml "$GITHUB_WORKSPACE/config"
          # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð±ÐµÐ· Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ ÐºÑÑˆÐ°
          rm -rf .west/manifest-tmp || true
          west update
          west zephyr-export

          echo "ðŸª³ Debug Logs"
          echo "Top dir  : $(west topdir)"
          echo "All folders:"
          ls -la $(west topdir)
          echo ""
          echo "West projects:"
          west list
          echo ""
          echo "ðŸ“¦ Looking for Zephyr..."
          find $(west topdir) -maxdepth 2 -name "VERSION" -o -name "CMakeLists.txt" | head -10
          echo ""
          echo "ðŸ“¦ ZMK location:"
          ls -la $(west topdir)/zmk/ 2>/dev/null || echo "ZMK not found"
          echo ""
          echo "ðŸ“¦ Checking for Zephyr in modules:"
          ls -la $(west topdir)/modules/zephyr/ 2>/dev/null || echo "Not in modules/zephyr"
          echo ""
          echo "ðŸ“¦ Zephyr VERSION content (if found):"
          find $(west topdir) -name "VERSION" -type f -exec echo "Found: {}" \; -exec head -5 {} \; | head -20

      - name: Download keymaps
        uses: actions/download-artifact@v4
        with:
          name: generated-keymaps
          path: config

      - name: Stage keymaps and overlays into source tree
        shell: bash
        run: |
          mkdir -p zmk/app/overlays

          if [[ "${{ matrix.combo.format }}" != "reset" ]]; then
            cp config/${{ matrix.combo.keymap }}.keymap zmk/app/overlays/charybdis.keymap

            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ .dtsi Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· config
            cp config/*.dtsi zmk/app/overlays/ 2>/dev/null || true
          fi

      - name: Inject custom shields
        if: ${{ matrix.combo.format != 'reset' }}
        shell: bash
        run: |
          ZMK_SHIELDS_DIR="$GITHUB_WORKSPACE/zmk/app/boards/shields"
          mkdir -p "$ZMK_SHIELDS_DIR"
          cp -r "boards/shields/charybdis_${{ matrix.combo.format }}" "$ZMK_SHIELDS_DIR/"

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ charybdis-layouts.dtsi Ð¸Ð· config Ð² shield Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
          for d in "$ZMK_SHIELDS_DIR"/*; do
            [ -f "config/charybdis-layouts.dtsi" ] && cp "config/charybdis-layouts.dtsi" "$d/" || true
          done

      - name: Build combo ${{ matrix.combo.name }}
        shell: bash
        working-directory: zmk/app
        run: |
          set -euo pipefail

          KM="${{ matrix.combo.keymap }}"
          FM="${{ matrix.combo.format }}"
          NM="${{ matrix.combo.name }}"
          BD="${{ matrix.combo.board }}"

          declare -A LIST=(
            [bt]="charybdis_left charybdis_right"
            [reset]="settings_reset"
          )

          mkdir -p "$GITHUB_WORKSPACE/out/$NM"
          CONFIG_DIR="$GITHUB_WORKSPACE/config"

          for SH in ${LIST[$FM]}; do
            BUILD_DIR=$(mktemp -d)

            if [[ "$FM" == "bt" && "$SH" == *right ]]; then
              SNIPPET_OPTION="-DSNIPPET=studio-rpc-usb-uart"
            else
              SNIPPET_OPTION=""
            fi

            if [[ "$FM" != "reset" ]]; then
              KEYMAP_OPTION="-DKEYMAP_FILE=overlays/charybdis.keymap"
            else
              KEYMAP_OPTION=""
            fi

            echo "ðŸª³ Debug Logs"
            echo "Build Variables:"
            echo "â†’ Keymap    : $KM"
            echo "â†’ Format    : $FM"
            echo "â†’ Name      : $NM"
            echo "â†’ Board     : $BD"
            echo "â†’ KeymapOpt : $KEYMAP_OPTION"
            echo "â†’ Snippet   : $SNIPPET_OPTION"
            echo "â†’ Build dir : $BUILD_DIR"

            echo "ðŸ›  Starting build..."
            west build -p \
              -d "$BUILD_DIR" \
              -b "$BD" \
              -- \
              "-DZMK_CONFIG=$CONFIG_DIR" \
              "-DSHIELD=$SH" \
              "$KEYMAP_OPTION" \
              "$SNIPPET_OPTION"

            ART=$(if [[ -f "$BUILD_DIR/zephyr/zmk.uf2" ]]; then echo zmk.uf2; else echo zmk.bin; fi)
            cp "$BUILD_DIR/zephyr/$ART" "$GITHUB_WORKSPACE/out/$NM/$SH.${ART##*.}"
          done

      - name: Upload firmware bundle
        uses: actions/upload-artifact@v4
        with:
          name: charybdis-${{ matrix.combo.name }}
          path: ${{ github.workspace }}/out/${{ matrix.combo.name }}/**

  release-firmware:
    name: Release Firmware
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: combo-artifacts/

      - name: Zip each combo
        working-directory: combo-artifacts
        run: |
          for d in */; do
            zip -j "${d%/}.zip" "$d"*
          done

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Firmware Release ${{ github.ref_name }}
          files: combo-artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
